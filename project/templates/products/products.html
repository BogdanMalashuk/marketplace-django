{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<form method="get" action="" class="search-form d-flex flex-column align-items-center gap-3">

    <div class="d-flex gap-2 flex-wrap justify-content-center">
        <input type="text" name="q" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." value="{{ request.GET.q }}" class="search-input">

        <select name="category" class="search-select">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            {% for category in categories %}
                <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>
                    {{ category.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="price-slider">
        <label>–¶–µ–Ω–∞:</label>
        <input type="range" id="min_price" name="min_price"
               min="{{ price_min_limit }}" max="{{ price_max_limit }}"
               value="{{ min_price }}">
        <input type="range" id="max_price" name="max_price"
               min="{{ price_min_limit }}" max="{{ price_max_limit }}"
               value="{{ max_price }}">

        <div class="range-labels">
            <span>–û—Ç: <span id="min_price_value">{{ min_price }}</span> ‚ÇΩ</span>
            <span>–î–æ: <span id="max_price_value">{{ max_price }}</span> ‚ÇΩ</span>
        </div>
    </div>

    <button type="submit" class="search-button">üîç –ù–∞–π—Ç–∏</button>
</form>

{% if page_obj %}
<div class="product-list">
    {% for product in page_obj %}
        <div class="product-card">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
            {% else %}
                <img src="/media/products/default_product_image.jpg" alt="{{ product.name }}" class="product-image">
            {% endif %}

            <h2 class="product-name">{{ product.name|slice:":20" }}{% if product.name|length > 20 %}...{% endif %}</h2>
            <p class="product-price">{{ product.price|floatformat:2 }} ‚ÇΩ</p>
            <a href="{% url 'product_detail' product.slug %}" class="view-details">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
        </div>
    {% endfor %}
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                 {% if selected_category %}category={{ selected_category }}&{% endif %}
                 {% if min_price %}min_price={{ min_price }}&{% endif %}
                 {% if max_price %}max_price={{ max_price }}&{% endif %}
                 page=1">&laquo;</a>
        <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                 {% if selected_category %}category={{ selected_category }}&{% endif %}
                 {% if min_price %}min_price={{ min_price }}&{% endif %}
                 {% if max_price %}max_price={{ max_price }}&{% endif %}
                 page={{ page_obj.previous_page_number }}">‚Äπ</a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
            <span class="current">{{ num }}</span>
        {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                     {% if selected_category %}category={{ selected_category }}&{% endif %}
                     {% if min_price %}min_price={{ min_price }}&{% endif %}
                     {% if max_price %}max_price={{ max_price }}&{% endif %}
                     page={{ num }}">{{ num }}</a>
        {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                     {% if selected_category %}category={{ selected_category }}&{% endif %}
                     {% if min_price %}min_price={{ min_price }}&{% endif %}
                     {% if max_price %}max_price={{ max_price }}&{% endif %}
                     page={{ num }}">{{ num }}</a>
        {% elif forloop.first or forloop.last %}
            <span class="dots">...</span>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
        <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                 {% if selected_category %}category={{ selected_category }}&{% endif %}
                 {% if min_price %}min_price={{ min_price }}&{% endif %}
                 {% if max_price %}max_price={{ max_price }}&{% endif %}
                 page={{ page_obj.next_page_number }}">‚Ä∫</a>
        <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}
                 {% if selected_category %}category={{ selected_category }}&{% endif %}
                 {% if min_price %}min_price={{ min_price }}&{% endif %}
                 {% if max_price %}max_price={{ max_price }}&{% endif %}
                 page={{ page_obj.paginator.num_pages }}">&raquo;</a>
    {% endif %}
</div>
{% endif %}

<script>
    const minRange = document.getElementById('min_price');
    const maxRange = document.getElementById('max_price');
    const minValue = document.getElementById('min_price_value');
    const maxValue = document.getElementById('max_price_value');

    function updateRangeValues() {
        minValue.textContent = minRange.value;
        maxValue.textContent = maxRange.value;
    }

    minRange.addEventListener('input', updateRangeValues);
    maxRange.addEventListener('input', updateRangeValues);
</script>

{% endblock %}
